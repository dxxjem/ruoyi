# 智能文档合规性检查平台 - 实施设计方案

> **版本**: v2.2
> **最后更新**: 2025-12-29
> **目标**: 5-6 周完成可演示的最小原型系统
> **基于**: RuoYi-Vue-Plus v5.5.1

---

## 一、项目概述

### 1.1 项目背景

基于 RuoYi-Vue-Plus v5.5.1 框架构建的 B/S 架构智能合规审计平台：

- **MVP阶段**：采用“规则引擎 + 关键词匹配（硬规则）”实现 PDF 文档的条款级合规性自动检查（可演示闭环）。
- **演进阶段**：在MVP闭环基础上逐步引入“多策略 RAG / HyDE / 结构化定位”等能力（与PRD保持一致）。

**核心目标**: 降低人工复核成本 70% 以上，提升合规检查覆盖率与准确性。

### 1.3 对齐说明（v2.2变更）

本次更新基于当前代码现状（截至 **2025-12-29**）对实施设计进行对齐，重点修正：

- 目录结构/关键文件引用中“已存在 vs 待新增”的不一致（原文中部分文件尚未落地）。
- API 口径与当前 Controller 实现的 Method/Path 不一致（例如：结果列表、导出接口等）。
- 6周计划任务重排：将已完成的“CRUD/双数据源/SQL脚本/前端两页”标记为完成，将缺失的“上传/解析/向量/检查执行/任务异步/结果页/导出闭环”纳入后续计划。

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue 3 + TS)                        │
├─────────────────────────────────────────────────────────────────┤
│  法规库管理 │ 文档上传 │ 任务列表 │ 结果列表 │ 报告导出         │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────────┐
│                    后端 (Spring Boot 3.5.7)                     │
├─────────────────────────────────────────────────────────────────┤
│  新模块: ruoyi-modules/ruoyi-compliance/                        │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Knowledge    │  │ Check Engine │  │ SnailJob     │          │
│  │ Base Mgmt    │  │ (硬规则)      │  │ Executor     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Document     │  │ Vector       │  │ Reporting    │          │
│  │ Parser       │  │ Embedding    │  │ Service      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        基础设施层                                │
├─────────────────────────────────────────────────────────────────┤
│  MySQL (业务) │ PostgreSQL+pgvector (向量) │ Redis │ Minio     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、数据库设计

### 2.1 双数据库架构

**MySQL业务库** (`ry` - 现有数据库):
- `compliance_document` - 待检查文档表
- `compliance_check_task` - 检查任务表
- `compliance_check_result` - 检查结果明细表

**PostgreSQL向量库** (`compliance_vector_db` - 新建):
- `compliance_regulation` - 法规库表
- `compliance_rule` - 规则配置表（含关键词数组）
- `compliance_document_chunk` - 文档切块表（含向量嵌入）

### 2.2 核心表结构（PostgreSQL - compliance_vector_db）

#### 表1: 法规文档表 (compliance_regulation)

```sql
CREATE TABLE compliance_regulation (
    regulation_id BIGSERIAL PRIMARY KEY,
    regulation_code VARCHAR(100) NOT NULL UNIQUE,
    regulation_name VARCHAR(500) NOT NULL,
    category VARCHAR(100),
    effective_date DATE,
    status CHAR(1) DEFAULT '0',
    file_url VARCHAR(500),
    file_size BIGINT,
    remark TEXT,
    create_dept BIGINT,
    create_by BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE compliance_regulation IS '法规库表';
COMMENT ON COLUMN compliance_regulation.regulation_id IS '法规ID';
COMMENT ON COLUMN compliance_regulation.regulation_code IS '法规编码';
COMMENT ON COLUMN compliance_regulation.regulation_name IS '法规名称';
COMMENT ON COLUMN compliance_regulation.category IS '分类';
COMMENT ON COLUMN compliance_regulation.effective_date IS '生效日期';
COMMENT ON COLUMN compliance_regulation.status IS '状态（0正常 1停用）';
COMMENT ON COLUMN compliance_regulation.file_url IS '文件URL';
COMMENT ON COLUMN compliance_regulation.file_size IS '文件大小（字节）';
COMMENT ON COLUMN compliance_regulation.remark IS '备注';
COMMENT ON COLUMN compliance_regulation.create_dept IS '创建部门';
COMMENT ON COLUMN compliance_regulation.create_by IS '创建者';
COMMENT ON COLUMN compliance_regulation.create_time IS '创建时间';
COMMENT ON COLUMN compliance_regulation.update_by IS '更新者';
COMMENT ON COLUMN compliance_regulation.update_time IS '更新时间';

-- 索引
CREATE INDEX idx_regulation_code ON compliance_regulation(regulation_code);
CREATE INDEX idx_regulation_category ON compliance_regulation(category);
CREATE INDEX idx_regulation_status ON compliance_regulation(status);
```

#### 表2: 规则配置表 (compliance_rule)

```sql
CREATE TABLE compliance_rule (
    rule_id BIGSERIAL PRIMARY KEY,
    rule_code VARCHAR(100) NOT NULL UNIQUE,
    rule_name VARCHAR(200) NOT NULL,
    rule_type VARCHAR(20) NOT NULL, -- 'HARD' or 'RAG'
    category VARCHAR(100),
    keywords TEXT[], -- PostgreSQL数组类型
    description TEXT,
    severity VARCHAR(20) DEFAULT 'MEDIUM', -- 'HIGH', 'MEDIUM', 'LOW'
    status CHAR(1) DEFAULT '0',
    rule_order INT DEFAULT 0,
    create_dept BIGINT,
    create_by BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE compliance_rule IS '规则配置表';
COMMENT ON COLUMN compliance_rule.rule_id IS '规则ID';
COMMENT ON COLUMN compliance_rule.rule_code IS '规则编码';
COMMENT ON COLUMN compliance_rule.rule_name IS '规则名称';
COMMENT ON COLUMN compliance_rule.rule_type IS '规则类型（HARD-硬规则 RAG-语义规则）';
COMMENT ON COLUMN compliance_rule.category IS '分类';
COMMENT ON COLUMN compliance_rule.keywords IS '关键词数组（硬规则用）';
COMMENT ON COLUMN compliance_rule.description IS '描述';
COMMENT ON COLUMN compliance_rule.severity IS '严重程度（HIGH高 MEDIUM中 LOW低）';
COMMENT ON COLUMN compliance_rule.status IS '状态（0正常 1停用）';
COMMENT ON COLUMN compliance_rule.rule_order IS '排序号';
COMMENT ON COLUMN compliance_rule.create_dept IS '创建部门';
COMMENT ON COLUMN compliance_rule.create_by IS '创建者';
COMMENT ON COLUMN compliance_rule.create_time IS '创建时间';
COMMENT ON COLUMN compliance_rule.update_by IS '更新者';
COMMENT ON COLUMN compliance_rule.update_time IS '更新时间';

-- 索引
CREATE INDEX idx_rule_code ON compliance_rule(rule_code);
CREATE INDEX idx_rule_type ON compliance_rule(rule_type);
CREATE INDEX idx_rule_category ON compliance_rule(category);
CREATE INDEX idx_rule_status ON compliance_rule(status);
```

#### 表3: 文档切块表 (compliance_document_chunk)

```sql
-- 启用pgvector扩展（带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        CREATE EXTENSION vector;
    END IF;
END $$;

CREATE TABLE compliance_document_chunk (
    chunk_id BIGSERIAL PRIMARY KEY,
    regulation_id BIGINT NOT NULL,
    chunk_index INT NOT NULL,
    content TEXT NOT NULL,
    embedding vector(1536), -- OpenAI text-embedding-3-small
    metadata JSONB,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (regulation_id) REFERENCES compliance_regulation(regulation_id) ON DELETE CASCADE
);

COMMENT ON TABLE compliance_document_chunk IS '文档切块表';
COMMENT ON COLUMN compliance_document_chunk.chunk_id IS '切块ID';
COMMENT ON COLUMN compliance_document_chunk.regulation_id IS '法规ID';
COMMENT ON COLUMN compliance_document_chunk.chunk_index IS '切块序号';
COMMENT ON COLUMN compliance_document_chunk.content IS '文本内容';
COMMENT ON COLUMN compliance_document_chunk.embedding IS '向量嵌入（1536维）';
COMMENT ON COLUMN compliance_document_chunk.metadata IS '元数据（JSON格式）';
COMMENT ON COLUMN compliance_document_chunk.create_time IS '创建时间';

-- 创建HNSW向量索引（高性能）
CREATE INDEX idx_chunk_embedding ON compliance_document_chunk
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

COMMENT ON INDEX idx_chunk_embedding IS '向量余弦相似度HNSW索引';

-- 其他索引
CREATE INDEX idx_chunk_regulation_id ON compliance_document_chunk(regulation_id);
CREATE INDEX idx_chunk_index ON compliance_document_chunk(chunk_index);
```

### 2.3 核心表结构（MySQL - ry）

#### 表4: 待检查文档表 (compliance_document)

```sql
CREATE TABLE compliance_document (
    document_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    document_name VARCHAR(200) NOT NULL COMMENT '文档名称',
    file_url VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_size BIGINT COMMENT '文件大小（字节）',
    file_type VARCHAR(20) DEFAULT 'PDF' COMMENT '文件类型',
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    uploader BIGINT COMMENT '上传人',
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态（PENDING待处理 PROCESSING处理中 COMPLETED已完成 FAILED失败）',
    remark TEXT COMMENT '备注',
    create_dept BIGINT COMMENT '创建部门',
    create_by BIGINT COMMENT '创建者',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新者',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag CHAR(1) DEFAULT '0' COMMENT '删除标志（0存在 2删除）',
    INDEX idx_status (status),
    INDEX idx_uploader (uploader),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB AUTO_INCREMENT=1000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='待检查文档表';
```

#### 表5: 检查任务表 (compliance_check_task)

```sql
CREATE TABLE compliance_check_task (
    task_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_name VARCHAR(200) NOT NULL COMMENT '任务名称',
    document_id BIGINT NOT NULL COMMENT '文档ID',
    rule_ids TEXT COMMENT '规则ID列表(JSON数组)',
    check_type VARCHAR(20) DEFAULT 'HARD' COMMENT '检查类型（HARD硬规则 RAG语义规则）',
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '任务状态（PENDING待处理 RUNNING运行中 COMPLETED已完成 FAILED失败）',
    progress INT DEFAULT 0 COMMENT '执行进度(0-100)',
    result_summary JSON COMMENT '检查结果摘要',
    error_message TEXT COMMENT '错误信息',
    execute_time DATETIME COMMENT '开始执行时间',
    complete_time DATETIME COMMENT '完成时间',
    create_dept BIGINT COMMENT '创建部门',
    create_by BIGINT COMMENT '创建者',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新者',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (document_id) REFERENCES compliance_document(document_id),
    INDEX idx_document_id (document_id),
    INDEX idx_status (status),
    INDEX idx_check_type (check_type),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB AUTO_INCREMENT=1000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='检查任务表';
```

#### 表6: 检查结果明细表 (compliance_check_result)

```sql
CREATE TABLE compliance_check_result (
    result_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_id BIGINT NOT NULL COMMENT '任务ID',
    document_id BIGINT NOT NULL COMMENT '文档ID',
    rule_id BIGINT COMMENT '规则ID',
    rule_name VARCHAR(200) COMMENT '规则名称',
    rule_type VARCHAR(20) COMMENT '规则类型（HARD RAG）',
    violated BOOLEAN DEFAULT FALSE COMMENT '是否违规',
    severity VARCHAR(20) COMMENT '严重程度（HIGH MEDIUM LOW）',
    location JSON COMMENT '违规位置（页码、段落等）',
    matched_content TEXT COMMENT '匹配内容',
    violation_desc TEXT COMMENT '违规描述',
    suggestion TEXT COMMENT '修改建议',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (task_id) REFERENCES compliance_check_task(task_id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES compliance_document(document_id),
    INDEX idx_task_id (task_id),
    INDEX idx_document_id (document_id),
    INDEX idx_rule_id (rule_id),
    INDEX idx_violated (violated),
    INDEX idx_severity (severity),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB AUTO_INCREMENT=1000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='检查结果明细表';
```

---

## 三、后端模块设计

### 3.1 模块目录结构

> 说明：本节同时描述“**当前已落地**”与“**规划待新增**”。为避免破坏既有CRUD接口，文件上传将通过新增接口补齐，而不是直接把现有 `POST /compliance/*` 改为 multipart。

```
ruoyi-modules/ruoyi-compliance/
├── pom.xml
└── src/main/java/org/dromara/compliance/
    ├── config/
    │   └── OpenAIEmbeddingConfig.java  ← OpenAI Embedding配置（已存在）
    ├── controller/
    │   ├── ComplianceRegulationController.java
    │   ├── ComplianceRuleController.java
    │   ├── ComplianceDocumentController.java
    │   ├── ComplianceCheckTaskController.java
    │   └── ComplianceCheckResultController.java
    ├── domain/
    │   ├── ComplianceRegulation.java
    │   ├── ComplianceRule.java
    │   ├── ComplianceDocumentChunk.java
    │   ├── ComplianceDocument.java
    │   ├── ComplianceCheckTask.java
    │   ├── ComplianceCheckResult.java
    │   ├── bo/  ← Business Object
    │   └── vo/  ← View Object
    ├── handler/
    │   └── ComplianceStringArrayTypeHandler.java  ← PostgreSQL TEXT[]处理（已存在）
    ├── mapper/
    │   ├── ComplianceRegulationMapper.java
    │   ├── ComplianceRuleMapper.java
    │   ├── ComplianceDocumentChunkMapper.java
    │   ├── ComplianceDocumentMapper.java
    │   ├── ComplianceCheckTaskMapper.java
    │   └── ComplianceCheckResultMapper.java
    ├── service/
    │   ├── IComplianceRegulationService.java
    │   ├── IComplianceRuleService.java
    │   ├── IComplianceDocumentService.java
    │   ├── IComplianceCheckTaskService.java
    │   ├── IComplianceCheckResultService.java
    │   └── impl/
    └── snailjob/  ← 预留包（当前未落地执行器）
        └── ComplianceCheckJobExecutor.java  ← 待新增：SnailJob执行器
```

#### 3.1.1 规划新增的核心类（用于补齐MVP闭环）

为补齐“上传→解析→向量→检查→结果→导出”的闭环，建议新增（示例命名，可按团队规范调整）：

- `org.dromara.compliance.controller.ComplianceDocumentUploadController`（或在现有 `ComplianceDocumentController` 中新增上传端点）  
  - `POST /compliance/document/upload`（multipart）上传PDF并生成 `compliance_document` 记录
- `org.dromara.compliance.controller.ComplianceRegulationUploadController`（或在现有 `ComplianceRegulationController` 中新增上传端点）  
  - `POST /compliance/regulation/upload`（multipart）上传法规文件并生成/更新 `compliance_regulation`
- `org.dromara.compliance.service.IDocumentParserService` + `impl.DocumentParserServiceImpl`  
  - PDFBox抽取文本、切块、写入 `compliance_document_chunk`
- `org.dromara.compliance.service.IVectorEmbeddingService` + `impl.VectorEmbeddingServiceImpl`  
  - OkHttp调用Embedding接口，写入pgvector列（或先落地为 JSON/数组，后续再迁移到vector类型）
- `org.dromara.compliance.service.IComplianceCheckService` + `impl.ComplianceCheckServiceImpl`  
  - HARD规则：关键词“全包含/命中阈值”检测，写入 `compliance_check_result`，并更新 `compliance_check_task.progress/status`
- `org.dromara.compliance.snailjob.ComplianceCheckJobExecutor`  
  - SnailJob异步执行（taskId入参），并在执行过程中分阶段更新进度
- `org.dromara.compliance.controller.ComplianceReportController`（可选）  
  - 聚合导出、报告摘要等（若沿用当前 `ComplianceCheckResultController.export/{taskId}`，该Controller可后置）

### 3.2 pom.xml依赖配置

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.dromara</groupId>
        <artifactId>ruoyi-modules</artifactId>
        <version>${revision}</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ruoyi-compliance</artifactId>
    <description>compliance合规性检查模块</description>

    <dependencies>
        <!-- 通用工具 -->
        <dependency>
            <groupId>org.dromara</groupId>
            <artifactId>ruoyi-common-core</artifactId>
        </dependency>
        <dependency>
            <groupId>org.dromara</groupId>
            <artifactId>ruoyi-common-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.dromara</groupId>
            <artifactId>ruoyi-common-mybatis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.dromara</groupId>
            <artifactId>ruoyi-common-oss</artifactId>
        </dependency>
        <dependency>
            <groupId>org.dromara</groupId>
            <artifactId>ruoyi-common-excel</artifactId>
        </dependency>

        <!-- PostgreSQL驱动 -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
        </dependency>

        <!-- pgvector JDBC支持 -->
        <dependency>
            <groupId>com.pgvector</groupId>
            <artifactId>pgvector</artifactId>
            <version>0.1.4</version>
        </dependency>

        <!-- PDFBox用于PDF解析 -->
        <dependency>
            <groupId>org.apache.pdfbox</groupId>
            <artifactId>pdfbox</artifactId>
            <version>2.0.29</version>
        </dependency>

        <!-- OkHttp用于调用OpenAI Embedding API -->
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>4.12.0</version>
        </dependency>

        <!-- SnailJob客户端 -->
        <dependency>
            <groupId>com.aizuda</groupId>
            <artifactId>snail-job-client-job-core</artifactId>
        </dependency>
    </dependencies>
</project>
```

### 3.3 核心实体类

#### ComplianceRule.java（不继承TenantEntity）

```java
package org.dromara.compliance.domain;

import com.baomidou.mybatisplus.annotation.*;
import org.dromara.common.mybatis.core.domain.BaseEntity;
import java.io.Serial;
import java.io.Serializable;
import java.util.List;

/**
 * 规则配置实体
 */
@Data
@TableName("compliance_rule")
public class ComplianceRule extends BaseEntity implements Serializable {

    @Serial
    private static final long serialVersionUID = 1L;

    @TableId(value = "rule_id")
    private Long ruleId;

    private String ruleCode;
    private String ruleName;
    private String ruleType;  // HARD-硬规则, RAG-语义规则
    private String category;

    // PostgreSQL TEXT[]类型，需要TypeHandler
    @TableField(typeHandler = ComplianceStringArrayTypeHandler.class)
    private List<String> keywords;

    private String description;
    private String severity;  // HIGH, MEDIUM, LOW
    private String status;
    private Integer ruleOrder;

    @TableField(fill = FieldFill.INSERT)
    private Long createDept;

    @TableField(fill = FieldFill.INSERT)
    private Long createBy;

    @TableField(fill = FieldFill.INSERT)
    private java.util.Date createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateBy;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private java.util.Date updateTime;
}
```

### 3.4 多数据源配置

**PostgreSQL向量数据源配置**（独立于MySQL主数据源）:

```yaml
# application-dev.yml
spring:
  datasource:
    dynamic:
      primary: master
      strict: true
      datasource:
        # MySQL主数据源（现有配置）
        master:
          driver-class-name: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:3306/ry?...
          username: root
          password: 123456

        # PostgreSQL向量数据源（新增）
        vector:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://localhost:5432/compliance_vector_db
          username: postgres
          password: 123456

# OpenAI Embedding API配置
compliance:
  openai:
    api-key: your-openai-api-key
    embedding-model: text-embedding-3-small
    api-url: https://api.openai.com/v1/embeddings
    timeout: 30000
```

---

## 四、核心服务实现

### 4.1 PDF解析服务

**功能**: 使用Apache PDFBox提取文本，按段落切块（500-1000字符）

**实现要点**:
- 使用PDFBox提取全部文本
- 按段落切块（保留段落结构）
- 建立Parent-Child关联关系
- 集成向量生成服务

### 4.2 向量生成服务

**功能**: 调用OpenAI Embedding API生成向量，转换为PGvector存储

**实现要点**:
- 支持OpenAI text-embedding-3-small模型（1536维）
- 使用OkHttp客户端调用API
- 处理响应并转换为PGvector对象

### 4.3 硬规则检查服务

**功能**: 关键词匹配算法，检测文档是否包含所有指定关键词

**核心逻辑**:
```java
// 检查所有关键词是否同时出现
for (ComplianceRule rule : rules) {
    boolean allMatched = true;
    for (String keyword : rule.getKeywords()) {
        if (!content.contains(keyword)) {
            allMatched = false;
            break;
        }
    }
    if (allMatched) {
        // 记录违规
        results.add(buildViolation(rule));
    }
}
```

### 4.4 SnailJob任务执行器

**功能**: 异步执行检查任务，实时更新进度

**实现要点**:
- 使用@JobExecutor注解标记
- 解析任务参数（taskId）
- 更新任务状态为RUNNING
- 调用检查服务
- 保存检查结果
- 更新任务状态为COMPLETED

---

## 五、前端设计

### 5.1 目录结构

> 说明：当前仓库前端目录为 `plus-ui-v5.5.1-v2.5.1/src/`，且已落地页面仅包含 `regulation` 与 `rule`。`document/task/result` 为规划待新增。

```
plus-ui-v5.5.1-v2.5.1/src/
├── api/compliance/
│   ├── regulation/
│   │   ├── index.ts  ← 法规API
│   │   └── types.ts  ← 类型定义
│   ├── rule/
│   │   ├── index.ts
│   │   └── types.ts
│   ├── document/  ← 待新增
│   ├── task/      ← 待新增
│   └── result/    ← 待新增
└── views/compliance/
    ├── regulation/
    │   └── index.vue  ← 法规管理页面
    ├── rule/
    │   └── index.vue  ← 规则管理页面
    ├── document/  ← 待新增：文档上传页面
    ├── task/      ← 待新增：任务列表页面
    └── result/    ← 待新增：结果列表页面
```

### 5.2 组件规范

- 使用 **el-table**（不是VXE Table）
- 使用Composition API + `<script setup>`
- TypeScript类型定义完整
- 遵循项目现有页面结构（参考system/user模块）

### 5.3 页面清单

1. **法规管理页面** (regulation/index.vue)
   - 法规列表展示
   - 法规元数据维护（已实现）
   - 文件上传（待补齐：对接 `POST /compliance/regulation/upload`）

2. **文档上传页面** (document/index.vue)
   - 文档上传
   - 任务创建
   - 规则包选择

3. **任务列表页面** (task/index.vue)
   - 任务列表展示
   - 状态显示
   - 进度条
   - 查看结果按钮

4. **结果列表页面** (result/index.vue)
   - 检查结果展示
   - 违规高亮
   - 导出Excel

---

## 六、6周开发计划

### 6.0 实际进展（截至 2025-12-29）

- ✅ 合规模块骨架与依赖已创建（`ruoyi-modules/ruoyi-compliance`）
- ✅ MySQL业务表/PG向量表脚本已提供（`script/sql/mysql/compliance_merged.sql`、`script/sql/postgres/compliance_vector_merged.sql`）
- ✅ 动态数据源已配置 `vector`（PostgreSQL）
- ✅ 后端已完成：法规/规则/文档/任务/结果 **CRUD**（包含导出）
- ✅ 前端已完成：法规管理、规则管理两页（CRUD）
- ⛔ 未闭环：文件上传、PDF解析切块、向量生成入库、合规检查执行、SnailJob执行器、任务/结果/导出页面

### 第1周：项目初始化和数据库搭建

**任务1.1**: 创建compliance模块骨架
- 创建目录结构
- 配置pom.xml依赖
- 创建基础包结构

**任务1.2**: PostgreSQL向量库搭建
- 安装PostgreSQL数据库
- 安装pgvector扩展
- 执行建表SQL脚本
- 创建向量索引

**任务1.3**: 多数据源配置
- 配置PostgreSQL向量数据源
- 测试双数据源连接

**验收标准**: 模块可编译，数据库可连接（✅已完成）

---

### 第2周：法规和规则管理

**任务2.1**: 法规实体、Mapper、Service、Controller
- 创建ComplianceRegulation相关类
- 实现CRUD接口
- 添加权限注解

**任务2.2**: 规则管理功能
- 创建ComplianceRule相关类
- 实现关键词数组配置
- 支持TypeHandler处理PostgreSQL数组

**任务2.3**: 法规规则前端页面
- 创建法规管理页面
- 创建规则管理页面
- 集成文件上传组件（待补齐：法规文件上传接口）

**验收标准**: 可以新增法规和规则，前端正常展示（✅页面与CRUD已完成；⛔法规文件上传待补齐）

---

### 第3周：文档解析和向量生成

**任务3.1**: 文档/法规文件上传闭环（补齐现有CRUD缺口）
- 新增 `POST /compliance/document/upload`（multipart）上传PDF，落库 `compliance_document`
- 新增 `POST /compliance/regulation/upload`（multipart）上传法规文件，落库 `compliance_regulation.file_url/file_size`
- 与OSS/Minio对接（或先以本地/Minio为主，接口预留）

**任务3.2**: PDF解析服务
- 集成Apache PDFBox
- 实现文本提取
- 实现文档切块算法
- 写入 `compliance_document_chunk`（切块数据源建议使用 `vector`）

**任务3.3**: 向量生成服务（MVP先打通链路）
- 配置OpenAI Embedding API
- 实现向量生成
- 转换为PGvector存储

**任务3.4**: 文档管理前端页面（补齐缺失页面）
- 新增 `views/compliance/document/index.vue`
- 新增 `api/compliance/document/*`

**验收标准**: 可以上传PDF并解析切块，切块可在PG库查询；Embedding链路可跑通（允许先以“写入占位/后补充真实vector写入”的方式分阶段验收）

---

### 第4周：合规检查核心功能

**任务4.1**: 硬规则检查服务
- 实现ComplianceCheckService
- 实现关键词匹配算法
- 实现违规检测逻辑
- 写入 `compliance_check_result`

**任务4.2**: 任务管理功能
- 补齐“创建后执行”的流程：任务创建后触发执行（同步/异步二选一）
- 统一状态流转：`PENDING → RUNNING → COMPLETED/FAILED`
- 执行过程中更新 `progress`

**任务4.3**: 结果查询与导出对齐
- 结果列表接口统一为 `GET /compliance/check/result/list/{taskId}`（与当前代码一致）
- 结果导出接口统一为 `POST /compliance/check/result/export/{taskId}`（与当前代码一致）

**任务4.4**: SnailJob任务集成
- 创建ComplianceCheckJobExecutor
- 配置SnailJob任务
- 测试异步执行

**验收标准**: 可执行硬规则检查并产出结果；任务状态与进度可观测；SnailJob执行器可异步跑通

---

### 第5周：结果展示和导出

**任务5.1**: 任务管理前端页面
- 创建任务列表页面
- 显示任务状态和进度
- 实现进度条组件
- 实现轮询刷新

**任务5.2**: 结果列表展示
- 创建结果列表页面
- 使用el-table展示结果
- 支持结果筛选和排序
- 高亮显示违规项

**任务5.3**: Excel导出功能
- 后端：沿用当前导出接口（按taskId导出）
- 前端：结果页增加导出按钮，调用导出接口

**任务5.4**: 页面美化和优化
- 统一页面风格
- 添加loading状态
- 优化错误提示

**验收标准**: 可以查看检查结果，可以导出Excel

---

### 第6周：测试和文档

**任务6.1**: 功能测试
- 端到端测试
- 边界条件测试
- 性能测试
- Bug修复

**任务6.2**: 用户文档编写
- 编写使用手册
- API文档补充
- 部署文档

**任务6.3**: 代码优化和发布准备
- 代码review
- 性能优化
- 安全加固

**验收标准**: 所有问题修复，功能稳定，可以上线演示

---

## 七、关键文件路径

### 后端关键文件

1. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\ruoyi-modules\ruoyi-compliance\pom.xml`
   - 模块依赖配置

2. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\ruoyi-admin\src\main\resources\application-dev.yml`
   - `vector` 数据源与 `compliance.openai` 配置入口

3. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\ruoyi-modules\ruoyi-compliance\src\main\java\org\dromara\compliance\config\OpenAIEmbeddingConfig.java`
   - Embedding配置（当前未被服务引用，待实现Embedding服务后接入）

4. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\ruoyi-modules\ruoyi-compliance\src\main\java\org\dromara\compliance\controller\ComplianceCheckTaskController.java`
   - 任务CRUD（后续补齐“创建后执行/触发SnailJob”）

5. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\script\sql\postgres\compliance_vector_merged.sql`
   - PostgreSQL完整建表脚本（已合并修复）

6. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\script\sql\mysql\compliance_merged.sql`
   - MySQL业务库完整建表脚本（已合并修复）

### 前端关键文件

7. `D:\test\ruoyi\plus-ui-v5.5.1-v2.5.1\src\views\compliance\regulation\index.vue`
   - 法规管理页面（已实现）

8. `D:\test\ruoyi\plus-ui-v5.5.1-v2.5.1\src\views\compliance\rule\index.vue`
   - 规则管理页面（已实现）

9. `D:\test\ruoyi\plus-ui-v5.5.1-v2.5.1\src\api\compliance\regulation\index.ts`
   - 法规API（已实现）

10. `D:\test\ruoyi\plus-ui-v5.5.1-v2.5.1\src\api\compliance\rule\index.ts`
   - 规则API（已实现）

### 配置文件

11. `D:\test\ruoyi\RuoYi-Vue-Plus-v5.5.1\ruoyi-admin\pom.xml`
   - 添加compliance模块依赖

---

## 八、风险提示和解决方案

### 技术风险

1. **PostgreSQL向量检索性能**
   - 风险: 大规模向量检索可能较慢
   - 解决: 使用HNSW索引提升检索速度，合理设置切块大小

2. **OpenAI API限流和成本**
   - 风险: API限流和费用较高
   - 解决: 实现本地缓存，避免重复生成，使用批量API

3. **PDF解析准确性**
   - 风险: 复杂PDF格式解析可能不准确
   - 解决: MVP只处理纯文本PDF，添加解析结果人工校验

4. **中文向量质量**
   - 风险: OpenAI Embedding对中文支持可能不如英文
   - 解决: 使用最新的text-embedding-3模型

### 开发风险

5. **多数据源事务管理**
   - 风险: MySQL和PostgreSQL跨库事务难以保证
   - 解决: 采用最终一致性方案，关键操作添加补偿机制

6. **SnailJob任务失败重试**
   - 风险: 任务可能因网络、超时等原因失败
   - 解决: 配置合理的重试策略，实现任务失败告警

---

## 九、实施检查清单

### 准备阶段
- [ ] 安装PostgreSQL数据库
- [ ] 安装pgvector扩展
- [ ] 获取OpenAI API Key
- [ ] 准备测试PDF文档

### 第1周检查点
- [x] 模块可以编译通过（代码已具备）
- [ ] PostgreSQL数据库可连接（环境验证）
- [x] 多数据源配置正常（配置已具备）

### 第2周检查点
- [x] 可以新增法规和规则（CRUD已具备）
- [x] 前端页面正常展示（法规/规则两页已具备）

### 第3周检查点
- [ ] 可以上传并解析PDF
- [ ] 可以生成向量并存储

### 第4周检查点
- [ ] 可以执行硬规则检查
- [ ] SnailJob任务正常执行

### 第5周检查点
- [ ] 可以查看检查结果
- [ ] 可以导出Excel

### 第6周检查点
- [ ] 所有功能测试通过
- [ ] 文档完整
- [ ] 可以上线演示

---

## 十、API接口设计

> 说明：为反映当前实现与后续补齐计划，本节将接口分为“已实现（CRUD）”与“规划新增（上传/执行闭环）”。

### 10.1 法规管理接口

#### 已实现：新增法规（元数据CRUD）
```
POST /compliance/regulation
Content-Type: application/json
```

#### 已实现：查询法规列表
```
GET /compliance/regulation/list?pageNum=1&pageSize=10
```

#### 规划新增：上传法规文件
```
POST /compliance/regulation/upload
Content-Type: multipart/form-data
```

### 10.2 规则管理接口

#### 添加规则
```
POST /compliance/rule
Content-Type: application/json

{
  "ruleCode": "RULE-HARD-001",
  "ruleName": "防火间距检查",
  "ruleType": "HARD",
  "keywords": ["防火间距", "不应小于", "米"],
  "severity": "HIGH"
}
```

### 10.3 检查任务接口

#### 规划新增：上传待检文档
```
POST /compliance/document/upload
Content-Type: multipart/form-data
```

#### 创建检查任务
```
POST /compliance/task

{
  "taskName": "建筑设计图合规检查",
  "documentId": 10,
  "ruleIds": "[1,2,3]"
}
```

#### 查询任务进度
```
GET /compliance/task/{taskId}
```

#### 规划新增：触发执行（同步/异步）
```
POST /compliance/task/{taskId}/execute
```

### 10.4 检查结果接口

#### 查询检查结果列表
```
GET /compliance/check/result/list/{taskId}
```

#### 导出Excel
```
POST /compliance/check/result/export/{taskId}
```

---

## 十一、演示场景

### MVP演示流程

**场景**: 检查一份标书文档是否符合某行业标准

1. **上传法规文档** → 手动配置3条规则
   - 规则1: 必须包含RTO指标
   - 规则2: 防火间距不应小于10米
   - 规则3: 疏散通道净宽度不应小于1.2米

2. **上传待检查文档** → 创建检查任务
   - 选择标书PDF文档
   - 选择上述3条规则

3. **执行检查** → 实时查看进度
   - SnailJob异步执行
   - 前端轮询刷新进度

4. **查看结果** → 发现2个违规问题
   - 缺少RTO指标
   - 疏散通道宽度不足

5. **导出报告** → 下载Excel检查清单

---

**文档结束**

> **版本历史**:
> - v1.0 (2025-12-20): 初始设计方案
> - v2.0 (2025-12-26): 评审与改进版
> - v2.1 (2025-12-27): 更新表结构，添加 create_dept 字段和完整索引
> - v2.2 (2025-12-29): 对齐当前代码实现，重排计划任务，修正目录与API口径
